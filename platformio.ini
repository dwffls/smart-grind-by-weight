; Default environment settings
[platformio]
default_envs = waveshare-esp32s3-touch-amoled-164

[env:waveshare-esp32s3-touch-amoled-164]
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = qio
board_upload.flash_size = 16MB
board_build.arduino.memory_type = qio_opi

build_flags =
    -Iinclude
    -Ofast
    -Wall
    -std=gnu++17
    '-D LV_CONF_PATH="${platformio.include_dir}/lv_conf.h"'
    -DARDUINO_USB_CDC_ON_BOOT=1
    -DBOARD_HAS_PSRAM
    -DLV_LVGL_H_INCLUDE_SIMPLE
    -DNO_GLOBAL_UPDATE     ; Required by esp32-flashz
    -DFZ_NOHTTPCLIENT      ; Disable HTTP client (BLE only)

build_unflags =
    -std=gnu++11

; Pin Arduino-ESP32 framework version (3.x uses ESP-IDF v5, needed for rmt_tx.h)
platform_packages =
    framework-arduinoespressif32@^3.0.7

extra_scripts = 
    tools/build-scripts/pre_build.py
    tools/build-scripts/post_build.py
    tools/build-scripts/custom_targets.py

build_src_filter = +<*> -<.git/> -<.svn/>

; Custom partition table for delta OTA updates
board_build.partitions = partitions.csv

; Include local components for delta OTA
lib_extra_dirs = components

    
; Upload via USB settings
upload_speed = 921600
upload_port = /dev/cu.usbmodem*

; Monitor settings  
monitor_speed = 115200
monitor_port = /dev/cu.usbmodem*
    
lib_deps = 
    lvgl/lvgl@^9.3.0
    moononournation/GFX Library for Arduino@^1.5.9
    https://github.com/vortigont/esp32-flashz.git
    ; Removed bspatch-arduino, using detools instead
    ; Removed olkal/HX711_ADC@^1.2.12, using custom HX711Core implementation

; Suppress Wire library logs to suppress known requestFrom(): i2cWriteReadNonStop returned Error -1
; messages popping while polling the touchscreen controller. We have to poll
; because the touchscreen does not support interrupts.
monitor_filters = esp32_exception_decoder, default, hiding_filter
monitor_options =
    --filter hiding_filter:--regex ".*i2cWriteReadNonStop.*" --invert

; (Unit test environment removed)
